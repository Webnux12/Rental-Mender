<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<title>Animated Directions WebView</title>
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no"/>
<script src="https://api.mapbox.com/mapbox-gl-js/v2.12.0/mapbox-gl.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Turf.js/6.5.0/turf.min.js"></script>
<link href="https://api.mapbox.com/mapbox-gl-js/v2.12.0/mapbox-gl.css" rel="stylesheet"/>
<style>
body { margin:0; padding:0; }
#map { position:absolute; top:0; bottom:0; width:100%; }
</style>
</head>
<body>
<div id="map"></div>
<script>
(function() {
function getParam(key, defaultValue) {
  const params = new URLSearchParams(window.location.search);
  return params.get(key) || defaultValue;
}
const token = getParam('token', '');
const startParam = getParam('start', '33.8938,35.5018');
const endParam = getParam('end', '33.9806,35.6170');
const speedKmh = parseFloat(getParam('speedKmh', '50'));
const profile = getParam('profile', 'driving');
const zoom = parseFloat(getParam('zoom', '13'));
const pitch = parseFloat(getParam('pitch', '45'));
const bearingFollow = getParam('bearingFollow', '1') === '1';
const showMarker = getParam('marker', '1') === '1';
// Convert lat,lng to lng,lat for Mapbox API
function parseLatLng(param) {
  const parts = param.split(',').map(Number);
  return [parts[1], parts[0]];
}
const start = parseLatLng(startParam);
const end = parseLatLng(endParam);
mapboxgl.accessToken = token;
const map = new mapboxgl.Map({
  container: 'map',
  style: 'mapbox://styles/mapbox/streets-v11',
  center: start,
  zoom: zoom,
  pitch: pitch,
  bearing: 0
});
map.on('load', () => {
  // Fetch directions from Mapbox Directions API
  fetch(`https://api.mapbox.com/directions/v5/mapbox/${profile}/${start.join(',')};${end.join(',')}?geometries=geojson&access_token=${token}`)
    .then(res => res.json())
    .then(data => {
      if (!data.routes || !data.routes[0]) return;
      const route = data.routes[0].geometry;
      // Add route source
      map.addSource('route', {
        type: 'geojson',
        data: {
          type: 'Feature',
          geometry: route
        }
      });
      // Draw the route line
      map.addLayer({
        id: 'route-line',
        type: 'line',
        source: 'route',
        layout: { 'line-join': 'round', 'line-cap': 'round' },
        paint: { 'line-color': '#3887be', 'line-width': 6 }
      });
      let marker;
      if (showMarker) {
        marker = new mapboxgl.Marker().setLngLat(route.coordinates[0]).addTo(map);
      }
      const line = turf.lineString(route.coordinates);
      const distance = turf.length(line);
      const durationHours = distance / speedKmh;
      const durationMs = durationHours * 3600 * 1000;
      const startTime = Date.now();
      function animate() {
        const elapsed = Date.now() - startTime;
        const t = Math.min(elapsed / durationMs, 1);
        const along = turf.along(line, distance * t).geometry.coordinates;
        if (showMarker) {
          marker.setLngLat(along);
        }
        if (bearingFollow) {
          const next = turf.along(line, distance * Math.min(t + 0.001, 1)).geometry.coordinates;
          const bearing = turf.bearing(turf.point(along), turf.point(next));
          map.easeTo({ center: along, bearing: bearing, duration: 50, essential: true });
        } else {
          map.easeTo({ center: along, duration: 50, essential: true });
        }
        if (t < 1) requestAnimationFrame(animate);
      }
      animate();
    });
});
})();
</script>
</body>
</html>
